{% assign section = args.section %}
{% assign depth = args.depth | default: 1 %}
{% assign ids = args.ids | default: "nav" %}
{% assign isIndex = page_section.index == page.meta_id %}

{% assign children = section.children | concat: section.pages | sortedByWeight %}

{% for child in children %}
    {% assign is_page = child.index == null %}
    {% assign id = ids | concat: "-", loop_index %}
    {% if is_page %}
    {% assign active = page.meta_id == child %}
    {% if child == section.index %}
        {% comment %}
        This is the page defining the section. Don't show both the section and its index!
        {% endcomment %}
        {% continue %}
    {% endif %}
    {% assign page_info = child | pageInfo %}
    <li class="md-nav__item {%- if active %} md-nav__item--active {%- endif %}">
        <a class="md-nav__link {%- if active %} md-nav__link--active {%- endif %}" href="{{ child | pageUrl }}">
            <span class="md-ellipsis">{{ page_info.data.nav_title | default: page_info.data.title }}</span>
        </a>
    </li>
    {% else %}
    {% assign active = page_section.index == child.index %}
    <li class="md-nav__item md-nav__item--section md-nav__item--nested {%- if active %} md-nav__item--active {%- endif %}">
        {% assign index_info = child.index | pageInfo %}
        {% assign grandchildren = child.children | concat: child.pages | sortedByWeight %}
        {% assign permalink = index_info.path | relUrl %}
        {% assign checked = false %}

        <input
          class="md-nav__toggle md-toggle {% if checked == false %} indeterminate {% endif %}"
          type="checkbox"
          id="{{ id }}"
          {% if checked %} checked {% endif %}
        />

        <div class="md-nav__link md-nav__container">
            <a class="md-nav__link" href="{{ permalink }}">{{ index_info.data.title }}</a>

            {% if grandchildren | length | gt: 1 %}
              <label class="md-nav__link" for="{{id}}" id="{{id}}_label">
                <span class="md-nav__icon md-icon"></span>
              </label>
            {% endif %}
        </div>
        <nav class="md-nav" data-md-level="{{ depth }}" data-labelledby="{{ path }}__label">
          <label class="md-nav__title" for="{{ path }}">
            <span class="md-nav__icon md-icon"></span>
            {{ index_info.data.title }}
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            {% include "partials/nav-item.html" section = child depth = (depth| plus: 1) ids = (ids | concat: '-') %}
          </ul>
        </nav>
    </li>
    {% endif %}
{% endfor %}
